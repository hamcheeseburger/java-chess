<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>체스</title>
    <script>
        let first = '';
        let second = '';

        function clicked(id) {
            if (first !== '') {
                second = id;
            } else {
                first = id;
            }

            if (first !== '' && second !== '') {
                sendToServer(first, second);
                first = '';
                second = '';
            }
        }

        function checkStatus() {
            fetch('/status', {
                method: "GET",
                headers: {
                    "Content-Type": "text/plain",
                }
            }).then((response) => {
                response.json().then(data => {
                    document.getElementById("statusResult")
                        .innerHTML = "검은말 : " + data.BLACK + "<br >"
                        + "흰말 : " + data.WHITE + "<br >"
                        + data.winner;
                });
            });
        }

        function calculateWinner(black, white) {
            if (black === white) {
                return "draw!"
            }
            if (black > white) {
                return "black win!"
            }
            return "white win!";
        }

        function sendToServer(first, second) {
            fetch('/move', {
                method: "POST",
                headers: {
                    "Content-Type": "text/plain",
                },
                body: "command=move " + first + " " + second
            }).then((response) => {
                    response.json().then(data => {
                        console.log(data.finished);
                        if (data.status === 400) {
                            alert(data.errorMessage);
                        }
                        if (data.finished === true) {
                            alert("게임이 종료되었습니다.");
                            document.location.href = '/start'
                            return;
                        }
                        location.reload();
                    });
                }
            );
        }

        function finishGame() {
            fetch('/end', {
                method: "POST",
                headers: {
                    "Content-Type": "text/plain",
                }
            }).then((response) => {
                    response.json().then(data => {
                        console.log(data.finished);
                        if (data.status === 400) {
                            alert(data.errorMessage);
                        }
                        if (data.finished === true) {
                            alert("게임이 종료되었습니다.");
                            document.location.href = '/start'
                            return;
                        }
                        location.reload();
                    });
                }
            );
        }

    </script>
</head>
<body>
<table>
    {{#board}}
    {{#boardSymbols}}
    <tr>
        {{#this}}
        {{#this}}
        <td id={{position}} onclick="clicked(this.id)">
            {{symbol}}
        </td>
        {{/this}}
        {{/this}}
    </tr>
    {{/boardSymbols}}
    {{/board}}
</table>
<br/>
<button id="btn" onclick="checkStatus()">status</button>
<p id="statusResult">
</p>
<form action="/end" method="POST">
    <input type="submit" value="end" />
</form>
</body>
</html>
